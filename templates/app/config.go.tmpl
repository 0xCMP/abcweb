package app

import (
	"fmt"
	"os"
	"time"
	"strings"

	"{{.ImportPath}}/rendering"
	{{if not .NoSessions -}}
	"{{.ImportPath}}/sessions"
	{{- end}}
	"github.com/pressly/chi"
	"github.com/spf13/cobra"
	"github.com/spf13/viper"
	"go.uber.org/zap"
)

// State is the configuration state for the entire app.
// The controllers are passed variables from this object when initialized.
type State struct {
	Config  *Config
	Log     *zap.Logger
	Router  *chi.Mux
	Render  rendering.Renderer
	Root    *cobra.Command
	{{if not .NoSessions -}}
	Session sessions.Overseer
	{{- end}}
}

// Config for the app loaded through environment variables, command line, or
// the config.toml file.
type Config struct {
	// LiveReload enabled or disabled
	LiveReload bool
	// Use the production logger (JSON and log level warn), or the
	// development logger (console and log level info)
	ProdLogger bool
	// http bind address. ":<port>" for all interfaces
	Bind string
	// https bind address. ":<port>" for all interfaces
	TLSBind string
	// TLS certificate file path
	TLSCertFile string
	// TLS key file path
	TLSKeyFile string
	// Maximum duration before timing out read of the request
	ReadTimeout time.Duration
	// Maximum duration before timing out write of the response
	WriteTimeout time.Duration
	// Templates folder path
	Templates string
	// Static assets input folder path
	AssetsIn string
	// Compiled assets output folder path
	AssetsOut string 
	// Disable precompilation of assets
	AssetsNoCompile bool
	// Disable minification of assets
	AssetsNoMinify bool 
	// Disable fingerprints in compiled asset filenames
	AssetsNoHash bool 
	// Disable Gzip compression of asset files
	AssetsNoCompress bool 
	// Disable browsers caching asset files by setting response headers
	AssetsNoCache bool 
	// RenderRecompile enables recompilation of the template on every render call.
	// This should be used in development mode so no server restart is required
	// on template file changes.
	RenderRecompile bool 
	{{if not .NoSessions -}}
	// Use the development mode sessions storer opposed to production mode storer
	SessionsDevStorer bool 
	{{- end}}
}

// RegisterFlags registers the configuration flag defaults and help strings
func (s *State) RegisterFlags() error {
	s.Root.Flags().BoolP("live-reload", "", false, "Enable or disable LiveReload")
	s.Root.Flags().BoolP("prod-logger", "", true, "Use the production logger, JSON and log level warn")
	s.Root.Flags().StringP("bind", "", ":80", `HTTP bind address, eg: ":80"`)
	s.Root.Flags().StringP("tls-bind", "", "", `HTTPS bind address, eg: ":443"`)
	s.Root.Flags().StringP("tls-cert-file", "", "", "TLS certificate file path")
	s.Root.Flags().StringP("tls-key-file", "", "", "TLS key file path")
	s.Root.Flags().DurationP("read-timeout", "", time.Second*30, "Maximum duration before timing out read of the request")
	s.Root.Flags().DurationP("write-timeout", "", time.Second*30, "Maximum duration before timing out write of the response")
	s.Root.Flags().StringP("templates", "", "./templates", "Templates folder path")
	s.Root.Flags().StringP("assets-in", "", "./assets", "Static assets input folder path")
	s.Root.Flags().StringP("assets-out", "", "./public", "Static assets output folder path")
	s.Root.Flags().BoolP("assets-no-compile", "", false, "Disable precompilation of assets")
	s.Root.Flags().BoolP("assets-no-minify", "", false, "Disable minification of assets")
	s.Root.Flags().BoolP("assets-no-hash", "", false, "Disable fingerprints in compiled asset filenames")
	s.Root.Flags().BoolP("assets-no-compress", "", false, "Disable gzip compression of asset files")
	s.Root.Flags().BoolP("assets-no-cache", "", false, "Disable browsers caching asset files by setting response headers")
	// This should be used in development mode to avoid having to reload the
	// server on every template file modification.
	s.Root.Flags().BoolP("render-recompile", "", false, "Enable recompilation of the template on each render")
	{{if not .NoSessions -}}
	s.Root.Flags().BoolP("sessions-dev-storer", "", false, "Use the development mode sessions storer")
	{{- end}}

	return nil 
}

// LoadConfig loads the configuration object
func (s *State) LoadConfig() error {
	{{$envAppNm := envAppName .AppName -}}
	env := os.Getenv("{{$envAppNm}}_ENV")

	v := viper.New()
	v.SetConfigType("toml")
	v.SetConfigFile("config.toml")
	v.SetEnvPrefix("{{$envAppNm}}")
	v.SetEnvKeyReplacer(strings.NewReplacer("-", "_"))
	v.ReadInConfig()

	if env == "" {
	  env = v.GetString("env")
	}
	if env == "" {
	  fmt.Println(`Warning: No environment chosen using {{$envAppNm}}_ENV or env field in config.toml, attempting to use fallback of "prod"`)
	  env = "prod"
	}

	v = v.Sub(env)
	if v == nil {
		return fmt.Errorf("unable to load environment %s from config file", env)
	}

	v.BindPFlags(s.Root.Flags())

	s.Config = &Config{
		LiveReload:        v.GetBool("live-reload"),
		ProdLogger:			 v.GetBool("prod-logger"),
		Bind:              v.GetString("bind"),
		TLSBind:           v.GetString("tls-bind"),
		TLSCertFile:       v.GetString("tls-cert-file"),
		TLSKeyFile:        v.GetString("tls-key-file"),
		ReadTimeout:       v.GetDuration("read-timeout"),
		WriteTimeout:      v.GetDuration("write-timeout"),
		Templates:         v.GetString("templates"),
		AssetsIn:          v.GetString("assets-in"),
		AssetsOut:         v.GetString("assets-out"),
		AssetsNoCompile:   v.GetBool("assets-no-compile"),
		AssetsNoMinify:    v.GetBool("assets-no-minify"),
		AssetsNoHash:      v.GetBool("assets-no-hash"),
		AssetsNoCompress:  v.GetBool("assets-no-compress"),
		AssetsNoCache:     v.GetBool("assets-no-cache"),
		RenderRecompile:   v.GetBool("render-recompile"),
		{{if not .NoSessions -}}
		SessionsDevStorer: v.GetBool("sessions-dev-storer"),
		{{- end}}
	}

	return nil
}
