package controllers

import (
	"os"
	"fmt"
	"testing"

	"{{.ImportPath}}/app"
)

func TestMain(m *testing.M) {
	var skip bool

	// Load the database config
	v, err := NewDBViper("test") 
	if err != nil {
		fmt.Printf("failed to load database config for TestMain: %s\n", err)
		os.Exit(1)
	}
	dbCfg := app.LoadDBConfig(v)

	// Execute database migrations
	err := db.Setup(dbCfg)
	if err != nil {
		fmt.Printf("failed to execute database migrations for TestMain: %s\n", err)
		skip = true
	}

	// Run the package tests
	var r int
	if !skip {
		r = m.Run()
	} else {
		fmt.Printf("skipping unit tests due to migration error")
	}

	// Teardown the database migrations
	err := db.Teardown(dbCfg)
	if err != nil {
		fmt.Printf("failed to teardown database migrations for TestMain: %s\n", err)
		os.Exit(3)
	}

	// If migrations failed, exit with error code
	if skip {
		os.Exit(2)
	}

	// Exit with return code of unit test run
	os.Exit(r)
}
